# å¤šå•†æˆ·ç”µå•†å¹³å°æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å°†å•ç§Ÿæˆ·ç”µå•†å¹³å°å‡çº§ä¸ºå¤šå•†æˆ·(Multi-Tenant)å¹³å°çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆã€‚

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. æ•°æ®éš”ç¦»ç­–ç•¥
é‡‡ç”¨**å…±äº«æ•°æ®åº“ã€å…±äº«è¡¨ç»“æ„ã€é€šè¿‡å•†æˆ·IDéš”ç¦»æ•°æ®**çš„æ–¹å¼ï¼ˆSchema-based Multi-Tenancyï¼‰

**ä¼˜ç‚¹:**
- æ•°æ®åº“èµ„æºåˆ©ç”¨ç‡é«˜
- æ˜“äºç»´æŠ¤å’Œå‡çº§
- è·¨å•†æˆ·æ•°æ®åˆ†ææ–¹ä¾¿
- æˆæœ¬è¾ƒä½

**å…³é”®å­—æ®µ:**
- æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡è¡¨éƒ½æ·»åŠ  `merchant_id` å­—æ®µ
- é€šè¿‡ `merchant_id = 1` æ ‡è¯†è¶…çº§å•†æˆ·(å¹³å°)
- æ™®é€šå•†æˆ· `merchant_id >= 2`

## æ•°æ®åº“è¡¨ç»“æ„

### 1. å•†æˆ·è¡¨ (merchants)

å•†æˆ·è¡¨æ˜¯å¤šç§Ÿæˆ·æ¶æ„çš„æ ¸å¿ƒè¡¨ï¼Œå­˜å‚¨æ‰€æœ‰å•†æˆ·ä¿¡æ¯ã€‚

```sql
CREATE TABLE `merchants` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,

  -- åŸºç¡€ä¿¡æ¯
  `merchant_code` VARCHAR(50) UNIQUE NOT NULL COMMENT 'å•†æˆ·ç¼–ç ',
  `merchant_name` VARCHAR(100) NOT NULL COMMENT 'å•†æˆ·åç§°',
  `merchant_type` TINYINT DEFAULT 1 COMMENT '1-è¶…çº§å•†æˆ·ï¼Œ2-æ™®é€šå•†æˆ·',

  -- è”ç³»ä¿¡æ¯
  `contact_name` VARCHAR(50),
  `contact_phone` VARCHAR(20),
  `contact_email` VARCHAR(100),
  `address` VARCHAR(255),

  -- è®¤è¯ä¿¡æ¯
  `certification_status` TINYINT DEFAULT 0 COMMENT '0-æœªè®¤è¯ï¼Œ1-å®¡æ ¸ä¸­ï¼Œ2-å·²è®¤è¯ï¼Œ3-å¤±è´¥',

  -- é…é¢é™åˆ¶
  `max_products` INT DEFAULT 1000 COMMENT 'æœ€å¤§å•†å“æ•°',
  `max_admins` INT DEFAULT 10 COMMENT 'æœ€å¤§ç®¡ç†å‘˜æ•°',
  `max_storage` BIGINT DEFAULT 10737418240 COMMENT 'æœ€å¤§å­˜å‚¨ç©ºé—´(å­—èŠ‚)',

  -- è´¢åŠ¡ä¿¡æ¯
  `commission_rate` DECIMAL(5,2) DEFAULT 0.00 COMMENT 'å¹³å°æŠ½æˆæ¯”ä¾‹',
  `balance` DECIMAL(12,2) DEFAULT 0.00 COMMENT 'è´¦æˆ·ä½™é¢',

  -- çŠ¶æ€
  `status` TINYINT DEFAULT 1 COMMENT '0-ç¦ç”¨ï¼Œ1-å¯ç”¨ï¼Œ2-å†»ç»“',
  `expire_time` TIMESTAMP NULL COMMENT 'åˆ°æœŸæ—¶é—´',

  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB COMMENT='å•†æˆ·è¡¨';
```

**å•†æˆ·ç±»å‹è¯´æ˜:**
- `merchant_type = 1`: è¶…çº§å•†æˆ·ï¼ˆå¹³å°ï¼‰ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ç®¡ç†æ‰€æœ‰å•†æˆ·
- `merchant_type = 2`: æ™®é€šå•†æˆ·ï¼Œåªèƒ½ç®¡ç†è‡ªå·±çš„æ•°æ®

### 2. è§’è‰²è¡¨ (roles) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `roles`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'æ‰€å±å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_roles_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id) ON DELETE CASCADE,
ADD INDEX idx_merchant_id (merchant_id);
```

**å˜æ›´è¯´æ˜:**
- æ¯ä¸ªè§’è‰²ç°åœ¨å½’å±äºç‰¹å®šå•†æˆ·
- å•†æˆ·åªèƒ½çœ‹åˆ°å’Œç®¡ç†è‡ªå·±çš„è§’è‰²
- è¶…çº§å•†æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰è§’è‰²

### 3. èœå•è¡¨ (menus) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `menus`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'æ‰€å±å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_menus_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id) ON DELETE CASCADE,
ADD INDEX idx_merchant_id (merchant_id);
```

**èœå•éš”ç¦»ç­–ç•¥:**
- å¹³å°çº§èœå•: `merchant_id = 1`ï¼Œæ‰€æœ‰å•†æˆ·å¯è§
- å•†æˆ·çº§èœå•: `merchant_id = å…·ä½“å•†æˆ·ID`ï¼Œä»…è¯¥å•†æˆ·å¯è§
- æ”¯æŒå•†æˆ·è‡ªå®šä¹‰èœå•ç»“æ„

### 4. ç®¡ç†å‘˜è¡¨ (admins) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `admins`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'æ‰€å±å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_admins_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id) ON DELETE CASCADE,
ADD INDEX idx_merchant_id (merchant_id);
```

**ç®¡ç†å‘˜æƒé™èŒƒå›´:**
- ç®¡ç†å‘˜åªèƒ½ç®¡ç†æ‰€å±å•†æˆ·çš„æ•°æ®
- è¶…çº§ç®¡ç†å‘˜(`merchant_id = 1`)å¯ç®¡ç†æ‰€æœ‰å•†æˆ·

### 5. å•†å“è¡¨ (products) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `products`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'æ‰€å±å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_products_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id),
ADD INDEX idx_merchant_id (merchant_id);
```

### 6. è®¢å•è¡¨ (orders) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `orders`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'å–å®¶å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_orders_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id),
ADD INDEX idx_merchant_id (merchant_id);
```

**è®¢å•è®¾è®¡è¯´æ˜:**
- `merchant_id`: å–å®¶ï¼ˆå•†æˆ·ï¼‰ID
- `user_id`: ä¹°å®¶ï¼ˆCç«¯ç”¨æˆ·ï¼‰ID
- æ”¯æŒè·¨å•†æˆ·è®¢å•ï¼ˆç”¨æˆ·å¯è´­ä¹°å¤šä¸ªå•†æˆ·çš„å•†å“ï¼‰

### 7. å“ç‰Œè¡¨ (brands) - æ·»åŠ å•†æˆ·å…³è”

```sql
ALTER TABLE `brands`
ADD COLUMN `merchant_id` BIGINT NOT NULL DEFAULT 1 COMMENT 'æ‰€å±å•†æˆ·ID' AFTER id,
ADD CONSTRAINT fk_brands_merchant_id FOREIGN KEY (merchant_id) REFERENCES merchants(id),
ADD INDEX idx_merchant_id (merchant_id);
```

## æ•°æ®å…³ç³»å›¾

```
å•†æˆ· (merchants) 1
    â†“
    â”œâ”€â”€ * ç®¡ç†å‘˜ (admins)
    â”‚       â†“ *
    â”‚       â””â”€â”€ * è§’è‰² (roles)
    â”‚               â†“ *
    â”‚               â””â”€â”€ * æƒé™ (permissions)
    â”‚
    â”œâ”€â”€ * èœå• (menus)
    â”‚
    â”œâ”€â”€ * å•†å“ (products)
    â”‚       â†“ *
    â”‚       â””â”€â”€ * å•†å“SKU (product_skus)
    â”‚
    â”œâ”€â”€ * è®¢å• (orders)
    â”‚       â†“ *
    â”‚       â””â”€â”€ * è®¢å•æ˜ç»† (order_items)
    â”‚
    â””â”€â”€ * å“ç‰Œ (brands)
```

## è¶…çº§å•†æˆ· (å¹³å°)

### åˆ›å»ºè¶…çº§å•†æˆ·

```sql
INSERT INTO `merchants` (
  `id`,
  `merchant_code`,
  `merchant_name`,
  `merchant_type`,
  `description`,
  `certification_status`,
  `status`,
  `expire_time`,
  `max_products`,
  `max_admins`,
  `created_at`
) VALUES (
  1,
  'SUPER_MERCHANT',
  'å¹³å°è¶…çº§å•†æˆ·',
  1,
  'å¹³å°è¶…çº§å•†æˆ·ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™',
  2,
  1,
  '2099-12-31 23:59:59',
  999999,
  999,
  NOW()
);
```

### æ•°æ®è¿ç§»

å°†ç°æœ‰æ•°æ®å½’å±åˆ°è¶…çº§å•†æˆ·:

```sql
-- è§’è‰²
UPDATE `roles` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;

-- èœå•
UPDATE `menus` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;

-- ç®¡ç†å‘˜
UPDATE `admins` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;

-- å•†å“
UPDATE `products` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;

-- è®¢å•
UPDATE `orders` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;

-- å“ç‰Œ
UPDATE `brands` SET `merchant_id` = 1 WHERE `merchant_id` IS NULL OR `merchant_id` = 0;
```

## åç«¯å®ä½“(Entity)å˜æ›´

### 1. Merchant Entity

åˆ›å»ºæ–°çš„å•†æˆ·å®ä½“:

```typescript
// backend/src/modules/merchants/entities/merchant.entity.ts
@Entity('merchants')
export class Merchant {
  @PrimaryGeneratedColumn({ type: 'bigint' })
  id: number;

  @Column({ name: 'merchant_code', unique: true })
  merchantCode: string;

  @Column({ name: 'merchant_name' })
  merchantName: string;

  @Column({ name: 'merchant_type', default: 1 })
  merchantType: number;

  // ... å…¶ä»–å­—æ®µ

  // å…³è”å…³ç³»
  @OneToMany(() => Role, role => role.merchant)
  roles: Role[];

  @OneToMany(() => Admin, admin => admin.merchant)
  admins: Admin[];

  @OneToMany(() => Menu, menu => menu.merchant)
  menus: Menu[];
}
```

### 2. Role Entity æ›´æ–°

```typescript
@Entity('roles')
export class Role {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ name: 'merchant_id', default: 1 })
  merchantId: number;

  // å…³è”å•†æˆ·
  @ManyToOne(() => Merchant, merchant => merchant.roles)
  @JoinColumn({ name: 'merchant_id' })
  merchant: Merchant;

  // ... å…¶ä»–å­—æ®µå’Œå…³ç³»
}
```

### 3. Admin Entity æ›´æ–°

```typescript
@Entity('admins')
export class Admin {
  @PrimaryGeneratedColumn({ type: 'bigint' })
  id: number;

  @Column({ name: 'merchant_id', default: 1 })
  merchantId: number;

  // å…³è”å•†æˆ·
  @ManyToOne(() => Merchant, merchant => merchant.admins)
  @JoinColumn({ name: 'merchant_id' })
  merchant: Merchant;

  // ... å…¶ä»–å­—æ®µå’Œå…³ç³»
}
```

### 4. Menu Entity æ›´æ–°

```typescript
@Entity('menus')
export class Menu {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ name: 'merchant_id', default: 1 })
  merchantId: number;

  // å…³è”å•†æˆ·
  @ManyToOne(() => Merchant, merchant => merchant.menus)
  @JoinColumn({ name: 'merchant_id' })
  merchant: Merchant;

  // ... å…¶ä»–å­—æ®µå’Œå…³ç³»
}
```

## ä¸šåŠ¡é€»è¾‘è°ƒæ•´

### 1. æ•°æ®æŸ¥è¯¢è¿‡æ»¤

æ‰€æœ‰æŸ¥è¯¢å¿…é¡»æ·»åŠ å•†æˆ·IDè¿‡æ»¤:

```typescript
// ç¤ºä¾‹ï¼šæŸ¥è¯¢è§’è‰²
async findRolesByMerchant(merchantId: number) {
  return this.roleRepository.find({
    where: { merchantId },
    relations: ['permissions']
  });
}

// ç¤ºä¾‹ï¼šæŸ¥è¯¢èœå•
async findMenusByMerchant(merchantId: number) {
  return this.menuRepository.find({
    where: { merchantId, status: 1 },
    order: { orderNum: 'ASC' }
  });
}
```

### 2. æƒé™æ§åˆ¶

åœ¨æ‰€æœ‰æ¥å£ä¸­æ·»åŠ å•†æˆ·éš”ç¦»:

```typescript
// è£…é¥°å™¨ï¼šç¡®ä¿åªèƒ½è®¿é—®è‡ªå·±å•†æˆ·çš„æ•°æ®
@UseGuards(MerchantGuard)
@Controller('roles')
export class RolesController {
  @Get()
  async findAll(@CurrentMerchant() merchantId: number) {
    return this.rolesService.findByMerchant(merchantId);
  }

  @Post()
  async create(
    @CurrentMerchant() merchantId: number,
    @Body() createDto: CreateRoleDto
  ) {
    return this.rolesService.create({
      ...createDto,
      merchantId
    });
  }
}
```

### 3. è¶…çº§ç®¡ç†å‘˜ç‰¹æƒ

è¶…çº§ç®¡ç†å‘˜å¯ä»¥è·¨å•†æˆ·æŸ¥è¯¢:

```typescript
async findAll(adminId: number) {
  const admin = await this.findAdminWithMerchant(adminId);

  // è¶…çº§å•†æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
  if (admin.merchant.merchantType === 1) {
    return this.roleRepository.find();
  }

  // æ™®é€šå•†æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„
  return this.roleRepository.find({
    where: { merchantId: admin.merchantId }
  });
}
```

## å•†æˆ·ç®¡ç†åŠŸèƒ½

### 1. å•†æˆ·æ³¨å†Œ/å…¥é©»

```typescript
// å•†æˆ·æ³¨å†Œæµç¨‹
async createMerchant(dto: CreateMerchantDto) {
  // 1. åˆ›å»ºå•†æˆ·
  const merchant = await this.merchantRepository.save({
    merchantCode: this.generateMerchantCode(),
    merchantName: dto.merchantName,
    merchantType: 2, // æ™®é€šå•†æˆ·
    certificationStatus: 0, // å¾…è®¤è¯
    status: 0, // å¾…å®¡æ ¸
    ...dto
  });

  // 2. åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜
  const admin = await this.adminService.create({
    username: dto.adminUsername,
    password: dto.adminPassword,
    merchantId: merchant.id,
    realName: dto.contactName
  });

  // 3. åˆ†é…é»˜è®¤è§’è‰²
  const defaultRole = await this.roleService.createDefaultRole(merchant.id);
  await this.adminService.assignRole(admin.id, defaultRole.id);

  // 4. åˆ›å»ºé»˜è®¤èœå•
  await this.menuService.createDefaultMenus(merchant.id);

  return merchant;
}
```

### 2. å•†æˆ·å®¡æ ¸

```typescript
async auditMerchant(merchantId: number, status: number, reason?: string) {
  const merchant = await this.merchantRepository.findOne({
    where: { id: merchantId }
  });

  merchant.certificationStatus = status;
  merchant.certificationTime = new Date();

  if (status === 2) { // å®¡æ ¸é€šè¿‡
    merchant.status = 1; // å¯ç”¨
    merchant.expireTime = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000); // 1å¹´
  }

  return this.merchantRepository.save(merchant);
}
```

### 3. å•†æˆ·é…é¢ç®¡ç†

```typescript
async checkQuota(merchantId: number, type: 'products' | 'admins') {
  const merchant = await this.findOne(merchantId);

  if (type === 'products') {
    const productCount = await this.productRepository.count({
      where: { merchantId }
    });
    return productCount < merchant.maxProducts;
  }

  if (type === 'admins') {
    const adminCount = await this.adminRepository.count({
      where: { merchantId }
    });
    return adminCount < merchant.maxAdmins;
  }

  return false;
}
```

## å‰ç«¯è°ƒæ•´

### 1. å•†æˆ·ä¸Šä¸‹æ–‡

åœ¨ç™»å½•åè·å–å¹¶å­˜å‚¨å•†æˆ·ä¿¡æ¯:

```typescript
// stores/merchant.ts
export const useMerchantStore = defineStore('merchant', {
  state: () => ({
    merchantId: null,
    merchantInfo: null,
    isSuperMerchant: false
  }),

  actions: {
    async loadMerchantInfo() {
      const info = await api.getMerchantInfo();
      this.merchantId = info.id;
      this.merchantInfo = info;
      this.isSuperMerchant = info.merchantType === 1;
    }
  }
});
```

### 2. è¯·æ±‚æ‹¦æˆª

æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨å¸¦ä¸Šå•†æˆ·ID:

```typescript
// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(config => {
  const merchantStore = useMerchantStore();
  if (merchantStore.merchantId) {
    config.headers['X-Merchant-Id'] = merchantStore.merchantId;
  }
  return config;
});
```

### 3. èœå•æ¸²æŸ“

åªæ˜¾ç¤ºå½“å‰å•†æˆ·çš„èœå•:

```typescript
// è·å–èœå•
async function getMenus() {
  const merchantStore = useMerchantStore();
  const menus = await api.getMenus({
    merchantId: merchantStore.merchantId
  });
  return buildMenuTree(menus);
}
```

## æœ€ä½³å®è·µ

### 1. æ•°æ®éš”ç¦»åŸåˆ™

- **å¼ºåˆ¶è¿‡æ»¤**: æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»åŒ…å« `merchant_id` è¿‡æ»¤æ¡ä»¶
- **åˆ›å»ºæ—¶è‡ªåŠ¨å¡«å……**: åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨å¡«å……å½“å‰å•†æˆ·ID
- **åˆ é™¤/æ›´æ–°æ ¡éªŒ**: åˆ é™¤å’Œæ›´æ–°å‰æ ¡éªŒæ•°æ®æ‰€å±å•†æˆ·

### 2. æ€§èƒ½ä¼˜åŒ–

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_products_merchant_status ON products(merchant_id, status);
CREATE INDEX idx_orders_merchant_status ON orders(merchant_id, status);
CREATE INDEX idx_roles_merchant_status ON roles(merchant_id, status);
```

### 3. å®‰å…¨è€ƒè™‘

- **é˜²æ­¢è¶Šæƒè®¿é—®**: æ‰€æœ‰æ¥å£éªŒè¯ `merchantId` ä¸ç™»å½•ç”¨æˆ·çš„å•†æˆ·IDä¸€è‡´
- **æ•æ„Ÿæ•°æ®åŠ å¯†**: APIå¯†é’¥ã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- **å®¡è®¡æ—¥å¿—**: è®°å½•è·¨å•†æˆ·æ“ä½œæ—¥å¿—

### 4. æ‰©å±•æ€§è®¾è®¡

- **å•†æˆ·é…ç½®**: ä½¿ç”¨JSONå­—æ®µå­˜å‚¨çµæ´»é…ç½®
- **åŠŸèƒ½å¼€å…³**: é€šè¿‡é…ç½®æ§åˆ¶ä¸åŒå•†æˆ·çš„åŠŸèƒ½æƒé™
- **ä¸»é¢˜å®šåˆ¶**: æ”¯æŒå•†æˆ·è‡ªå®šä¹‰å“ç‰Œè‰²ã€Logoç­‰

## è¿ç§»æ­¥éª¤

1. **å¤‡ä»½æ•°æ®åº“**
   ```bash
   mysqldump -u root -p wechat_mall > backup_$(date +%Y%m%d).sql
   ```

2. **æ‰§è¡Œè¿ç§»è„šæœ¬**
   ```bash
   mysql -u root -p wechat_mall < database/migrations/add_multi_tenant_support.sql
   ```

3. **éªŒè¯æ•°æ®è¿ç§»**
   ```sql
   -- æ£€æŸ¥æ‰€æœ‰è¡¨çš„merchant_idæ˜¯å¦æ­£ç¡®
   SELECT 'roles', COUNT(*) FROM roles WHERE merchant_id = 1
   UNION ALL
   SELECT 'menus', COUNT(*) FROM menus WHERE merchant_id = 1
   UNION ALL
   SELECT 'admins', COUNT(*) FROM admins WHERE merchant_id = 1;
   ```

4. **æ›´æ–°åç«¯ä»£ç **
   - æ›´æ–°Entityå®šä¹‰
   - æ·»åŠ å•†æˆ·è¿‡æ»¤é€»è¾‘
   - å®ç°å•†æˆ·ç®¡ç†æ¥å£

5. **æµ‹è¯•**
   - åˆ›å»ºæµ‹è¯•å•†æˆ·
   - éªŒè¯æ•°æ®éš”ç¦»
   - æµ‹è¯•æƒé™æ§åˆ¶

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†è·¨å•†æˆ·å…±äº«çš„æ•°æ®ï¼Ÿ

A: å¯¹äºéœ€è¦å…±äº«çš„æ•°æ®ï¼ˆå¦‚å…¬å…±åˆ†ç±»ã€å“ç‰Œç­‰ï¼‰ï¼Œè®¾ç½® `merchant_id = 1`ï¼ˆå¹³å°çº§ï¼‰ï¼Œæ‰€æœ‰å•†æˆ·å¯è§ã€‚

### Q2: å¦‚ä½•å®ç°å•†æˆ·æ•°æ®ç»Ÿè®¡ï¼Ÿ

A:
```sql
-- å•†æˆ·æ•°æ®ç»Ÿè®¡è§†å›¾
CREATE VIEW merchant_stats AS
SELECT
  m.id,
  m.merchant_name,
  COUNT(DISTINCT p.id) as total_products,
  COUNT(DISTINCT o.id) as total_orders,
  SUM(o.actual_amount) as total_sales
FROM merchants m
LEFT JOIN products p ON m.id = p.merchant_id
LEFT JOIN orders o ON m.id = o.merchant_id
GROUP BY m.id;
```

### Q3: è¶…çº§ç®¡ç†å‘˜å¦‚ä½•ç®¡ç†æ‰€æœ‰å•†æˆ·ï¼Ÿ

A: åœ¨ä¸šåŠ¡é€»è¾‘ä¸­åˆ¤æ–­ `merchant_type === 1`ï¼Œè·³è¿‡ `merchant_id` è¿‡æ»¤ã€‚

## æ€»ç»“

æœ¬å¤šå•†æˆ·æ–¹æ¡ˆé‡‡ç”¨å…±äº«æ•°æ®åº“æ¶æ„ï¼Œé€šè¿‡ `merchant_id` å®ç°æ•°æ®éš”ç¦»ã€‚å…³é”®è¦ç‚¹:

1. âœ… æ‰€æœ‰æ ¸å¿ƒè¡¨éƒ½æ·»åŠ  `merchant_id` å¤–é”®
2. âœ… è¶…çº§å•†æˆ·(`id=1`)ä½œä¸ºå¹³å°ç®¡ç†æ–¹
3. âœ… æ‰€æœ‰æŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œéƒ½å¸¦å•†æˆ·è¿‡æ»¤
4. âœ… åç«¯Entityå’ŒServiceå±‚ç»Ÿä¸€å¤„ç†å•†æˆ·éš”ç¦»
5. âœ… å‰ç«¯é€šè¿‡å•†æˆ·ä¸Šä¸‹æ–‡å’Œè¯·æ±‚æ‹¦æˆªå™¨ä¿è¯æ•°æ®å®‰å…¨

æ­¤æ–¹æ¡ˆæ”¯æŒ:
- ğŸ¯ æ— é™æ‰©å±•å•†æˆ·æ•°é‡
- ğŸ¯ çµæ´»çš„æƒé™æ§åˆ¶
- ğŸ¯ å®Œæ•´çš„æ•°æ®éš”ç¦»
- ğŸ¯ é«˜æ•ˆçš„è·¨å•†æˆ·æŸ¥è¯¢ï¼ˆå¹³å°çº§ï¼‰
- ğŸ¯ å•†æˆ·è‡ªå®šä¹‰é…ç½®
