# 商户管理接口文档

## 概述

商户管理模块提供了完整的商户CRUD（增删查改）功能，包括商户信息管理、状态控制、认证管理等。

## 基础信息

- **Base URL**: `http://localhost:3000/api`
- **认证方式**: Bearer Token (JWT)
- **Content-Type**: `application/json`

## API 接口列表

### 1. 创建商户

**接口**: `POST /merchants`

**描述**: 创建新商户（自动创建超级管理员、角色和权限）

**功能说明**:
- 创建商户时会自动执行以下操作：
  1. 生成商户API密钥对
  2. 创建商户专属的超级管理员（随机用户名和密码）
  3. 创建超级管理员角色（随机角色代码）
  4. 将管理员绑定到角色
  5. 为角色分配菜单管理相关权限
  6. 所有数据（管理员、角色、菜单）都关联到该商户（merchant_id）

**请求参数**:
```json
{
  "merchantCode": "TEST_MERCHANT_001",      // 必填，商户编码（唯一）
  "merchantName": "测试商户",               // 必填，商户名称
  "merchantType": 2,                        // 可选，商户类型：1-超级商户，2-普通商户（默认2）
  "legalPerson": "张三",                    // 可选，法人代表
  "businessLicense": "91110000000000000X",  // 可选，营业执照号
  "contactName": "李四",                    // 可选，联系人姓名
  "contactPhone": "13800138000",            // 可选，联系电话
  "contactEmail": "contact@merchant.com",   // 可选，联系邮箱
  "address": "北京市朝阳区xxx",             // 可选，商户地址
  "logo": "https://xxx.com/logo.png",       // 可选，Logo URL
  "description": "这是一个测试商户",         // 可选，商户描述
  "businessScope": "服装、鞋帽销售",        // 可选，经营范围
  "categoryIds": [1, 2, 3],                 // 可选，经营类目ID数组
  "settlementAccount": "6222020000000000",  // 可选，结算账户
  "settlementBank": "中国工商银行",         // 可选，结算银行
  "status": 1,                              // 可选，状态：0-禁用，1-启用，2-冻结（默认1）
  "maxProducts": 1000,                      // 可选，最大商品数量（默认1000）
  "maxAdmins": 10,                          // 可选，最大管理员数量（默认10）
  "maxStorage": 10737418240,                // 可选，最大存储空间（字节，默认10GB）
  "commissionRate": 5.0,                    // 可选，平台抽成比例（%，默认0）
  "config": {                               // 可选，商户配置JSON
    "theme": "default",
    "enableNotification": true
  },
  "webhookUrl": "https://xxx.com/webhook"   // 可选，Webhook回调地址
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 2,
    "merchantCode": "TEST_MERCHANT_001",
    "merchantName": "测试商户",
    "merchantType": 2,
    "contactName": "李四",
    "contactPhone": "13800138000",
    "contactEmail": "contact@merchant.com",
    "status": 1,
    "certificationStatus": 0,
    "apiKey": "mk_xxxxxxxxxxxxxxxxxx",
    "apiSecret": "xxxxxxxxxxxxxxxxxxxxxxxx",
    "createdAt": "2025-10-10 11:57:56",
    "updatedAt": "2025-10-10 11:57:56",
    // ... 其他字段

    // 🔑 自动创建的超级管理员凭证（仅在创建时返回）
    "superAdmin": {
      "username": "admin_ic0qxa2b",          // 随机生成的用户名
      "password": "GYO^ozajRlV8",            // 随机生成的明文密码（数据库存储加密后的密码）
      "email": "admin_ic0qxa2b@test_merchant_001.com"  // 自动生成的邮箱
    }
  },
  "msg": "创建成功"
}
```

**重要提示**:
- `superAdmin.password` 为明文密码，**仅在创建商户时返回一次**，请妥善保存
- 数据库中存储的是bcrypt加密后的密码
- 超级管理员用户名和密码都是随机生成的，保证唯一性
- 超级管理员自动拥有菜单管理权限

---

### 2. 查询商户列表（分页）

**接口**: `GET /merchants`

**描述**: 分页查询商户列表，支持多条件筛选

**查询参数**:
| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| page | number | 否 | 页码 | 1 |
| pageSize | number | 否 | 每页数量 | 10 |
| merchantCode | string | 否 | 商户编码（模糊搜索） | TEST |
| merchantName | string | 否 | 商户名称（模糊搜索） | 测试 |
| merchantType | number | 否 | 商户类型 | 2 |
| status | number | 否 | 状态 | 1 |
| certificationStatus | number | 否 | 认证状态 | 2 |
| contactPhone | string | 否 | 联系电话 | 138 |
| contactEmail | string | 否 | 联系邮箱 | test |

**请求示例**:
```
GET /merchants?page=1&pageSize=10&merchantType=2&status=1
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "items": [
      {
        "id": 2,
        "merchantCode": "TEST_MERCHANT_001",
        "merchantName": "测试商户",
        "merchantType": 2,
        "status": 1,
        "certificationStatus": 0,
        // ... 其他字段
      }
    ],
    "total": 15,
    "page": 1,
    "pageSize": 10,
    "totalPages": 2
  },
  "msg": "查询成功"
}
```

---

### 3. 查询单个商户详情

**接口**: `GET /merchants/:id`

**描述**: 根据ID查询商户详细信息

**路径参数**:
- `id`: 商户ID

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 2,
    "merchantCode": "TEST_MERCHANT_001",
    "merchantName": "测试商户",
    "merchantType": 2,
    "status": 1,
    "certificationStatus": 0,
    "maxProducts": 1000,
    "maxAdmins": 10,
    "maxStorage": 10737418240,
    "balance": "0.00",
    "frozenBalance": "0.00",
    "totalSales": "0.00",
    "createdAt": "2025-10-10 11:57:56",
    "updatedAt": "2025-10-10 11:57:56",
    // ... 完整字段
  },
  "msg": "查询成功"
}
```

---

### 4. 根据商户编码查询

**接口**: `GET /merchants/code/:merchantCode`

**描述**: 根据商户编码查询商户信息

**路径参数**:
- `merchantCode`: 商户编码

**响应示例**: 同上

---

### 5. 更新商户信息

**接口**: `PUT /merchants/:id`

**描述**: 更新商户信息（部分更新）

**路径参数**:
- `id`: 商户ID

**请求参数**: 同创建接口，所有字段可选

**请求示例**:
```json
{
  "merchantName": "测试商户（已更新）",
  "description": "这是一个已更新的测试商户",
  "maxProducts": 2000
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 2,
    "merchantName": "测试商户（已更新）",
    "maxProducts": 2000,
    // ... 其他字段
  },
  "msg": "更新成功"
}
```

---

### 6. 删除商户

**接口**: `DELETE /merchants/:id`

**描述**: 删除商户（硬删除）

**路径参数**:
- `id`: 商户ID

**注意事项**:
- 超级商户（merchantType=1）不允许删除
- 建议在删除前检查是否有关联数据

**响应示例**:
```json
{
  "code": 200,
  "data": null,
  "msg": "删除成功"
}
```

---

### 7. 更新商户状态

**接口**: `PUT /merchants/:id/status`

**描述**: 更新商户状态（启用/禁用/冻结）

**路径参数**:
- `id`: 商户ID

**请求参数**:
```json
{
  "status": 2  // 0-禁用，1-启用，2-冻结
}
```

**注意事项**:
- 超级商户不允许禁用或冻结

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 2,
    "status": 2,
    // ... 其他字段
  },
  "msg": "状态更新成功"
}
```

---

### 8. 更新认证状态

**接口**: `PUT /merchants/:id/certification`

**描述**: 更新商户认证状态

**路径参数**:
- `id`: 商户ID

**请求参数**:
```json
{
  "certificationStatus": 2  // 0-未认证，1-审核中，2-已认证，3-认证失败
}
```

**说明**:
- 当认证状态更新为"已认证"（2）时，会自动记录认证时间

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "id": 2,
    "certificationStatus": 2,
    "certificationTime": "2025-10-10 12:00:00",
    // ... 其他字段
  },
  "msg": "认证状态更新成功"
}
```

---

### 9. 获取商户统计信息

**接口**: `GET /merchants/:id/statistics`

**描述**: 获取商户的统计信息

**路径参数**:
- `id`: 商户ID

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "merchantId": 2,
    "merchantName": "测试商户",
    "balance": "1000.00",
    "frozenBalance": "100.00",
    "totalSales": "50000.00",
    "maxProducts": 1000,
    "maxAdmins": 10,
    "maxStorage": 10737418240,
    "currentProducts": 0,      // 当前商品数量
    "currentAdmins": 0,        // 当前管理员数量
    "usedStorage": 0           // 已用存储空间
  },
  "msg": "查询成功"
}
```

---

### 10. 重新生成API密钥对

**接口**: `POST /merchants/:id/regenerate-keys`

**描述**: 重新生成商户的API密钥对

**路径参数**:
- `id`: 商户ID

**说明**:
- 旧的密钥对将失效
- 生成的密钥对会同时保存到数据库

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "apiKey": "mk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "apiSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  },
  "msg": "API密钥对重新生成成功"
}
```

---

## 数据字典

### merchantType（商户类型）
| 值 | 说明 | 备注 |
|---|------|------|
| 1 | 超级商户（平台） | 拥有最高权限，不可删除 |
| 2 | 普通商户 | 普通商户 |

### status（状态）
| 值 | 说明 |
|---|------|
| 0 | 禁用 |
| 1 | 启用 |
| 2 | 冻结 |

### certificationStatus（认证状态）
| 值 | 说明 |
|---|------|
| 0 | 未认证 |
| 1 | 审核中 |
| 2 | 已认证 |
| 3 | 认证失败 |

---

## 错误码

| HTTP状态码 | 业务code | 说明 |
|-----------|----------|------|
| 200 | 200 | 成功 |
| 400 | 400 | 请求参数错误 |
| 401 | 401 | 未授权 |
| 404 | 404 | 商户不存在 |
| 409 | 409 | 商户编码已存在 |
| 500 | 500 | 服务器内部错误 |

---

## 测试示例

完整的测试脚本位于：`/test-merchants-api.sh`

运行测试：
```bash
bash test-merchants-api.sh
```

---

## 注意事项

1. **超级商户保护**：
   - 超级商户（merchantType=1）不允许删除
   - 超级商户不允许禁用或冻结

2. **商户编码唯一性**：
   - 商户编码（merchantCode）必须唯一
   - 创建和更新时都会检查

3. **API密钥安全**：
   - API密钥对在创建商户时自动生成
   - 可以通过重新生成接口更新密钥
   - 请妥善保管密钥，避免泄露

4. **认证时间**：
   - 只有当认证状态更新为"已认证"（2）时，才会记录认证时间

5. **分页查询**：
   - 默认每页10条
   - 支持多条件组合查询
   - 按创建时间倒序排序

---

## 更新日志

- **2025-10-10**: 初始版本
  - 完成商户CRUD基础功能
  - 实现状态和认证管理
  - 添加统计信息接口
  - 实现API密钥管理
