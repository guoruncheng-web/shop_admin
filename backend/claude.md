# 这是电商小程序后台管理系统的的后端项目
# 技术栈
1. nextjs框架, react框架, ts写法
# 登录模块
1. 采用的是token认证流程,当调用了/auth/login登录接口后,后端返回token给前端,前端储存token,后续调用其他接口的时候会在请求头的header authorization 带上token数据, 后端应该拦截请求验证token的有效性,登录后,后端应该把用户的个人信息以及商户id merchantId 放在req对象中。
2. 登录后,前端调用/auth/profile,后端返回用户登录账号的详细信息, 包括用户的基本信息 avatar, email, phone, username, realName, 角色信息 roleInfo, 商户信息 merchant, 用户账号所属的角色所拥有的菜单信息 menus。
# 商户模块
1. 项目采用的是多商户的模块,分为平台超级商户和普通商户
2. 平台商户和普通商户的区别
- 拥有商户管理的权限
- 拥有操作日志和登录日志的查看的权限
3. 后续其他模块的操作都必须跟商户有关系
4. 平台超级商户在新增商户的时候默认应该给这个商户分配一个随机的超级管理员和角色,并且进行关联。
- 静态分类 增 删 查 改 都必须是在所属的商户id,也就是说静态资源分类表(resource_categories)需要额外新加一个商户id的外键,如果此时静态资源分类表没有商户id外键,应该修改数据库表新加商户id外键,并且此时现有的表里面的数据的商户id初始化为平台超级商户的id
- 菜单管理 增 删 查 改 都必须是在所属的商户id,也就是说菜单表(menus)需要额外新加一个商户id的外键,如果此时菜单表没有商户id外键,应该修改数据库表新加商户id外键,并且此时现有的表里面的数据的商户id初始化为平台超级商户的id
- 资源管理 增 删 查 改 都必须是在所属的商户id,也就是说资源管理表(resources)需要额外新加一个商户id的外键,如果此时菜单表没有商户id外键,应该修改数据库表新加商户id外键,并且此时现有的表里面的数据的商户id初始化为平台超级商户的id
- 角色管理 增 删 查 改 都必须是在所属的商户id,也就是说角色表(roles)需要额外新加一个商户id的外键,如果此时角色表没有商户id外键,应该修改数据库表新加商户id外键,并且此时现有的表里面的数据的商户id初始化为平台超级商户的id
- 用户管理 增 删 查 改 都必须是在所属的商户id,也就是说用户表(users)需要额外新加一个商户id的外键,如果此时角色表没有商户id外键,应该修改数据库表新加商户id外键,并且此时现有的表里面的数据的商户id初始化为平台超级商户的id,如果此时登录的账号说超级商户,可以查询所有用户的数据,其他商户只能查询到本账号关联的用户数据
# 权限模块(菜单模块)
1. 数据库表为menus
2. 登录账号的时候,/auth/profile接口返回所属角色的菜单数据,后端要对菜单数据进行过滤保证唯一性
3. 菜单分为三个级别, 目录级别, 菜单级别, 按钮级别
4. 目录级别, 菜单级别 显示到前端的侧边栏里面
5. 菜单级别和按钮级别需要设置权限标识,权限标识需要保证全局唯一性
6. 当访问没有权限的接口的时候,后端应该报错返回错误信息给前端,你当前没有操作权限
7. 设置按钮权限的权限标识就是为了给前端的全局自定义指令来实现隐藏和显示按钮,/auth/profile返回账号所用户的权限标识,前端通过store储存起来,然后前端通过全局自定义指令在页面的按钮代码实现按钮的显示与隐藏
8. 我希望后端可以实现一个自定义装饰器,例如以下代码的Types
```
@Get()
@Types('system:cateogry:find',{ name:"查询资源分类" })
findAll() {
  return this.categoriesService.findAll();
}
```
- Types 可以用来拦截请求判断此时登录的账号有没有这个操作权限
- Types 可以用来记录操作权限,拦截此时的操作然后把操作权限 { name:"查询资源分类" } 的操作记录到操作权限表operation_logs中
9. 注意: 新增菜单的时候名称应该保持全局唯一性
# 用户管理
1. 用户管理的所有操作都应该是基于所属的商户下面
2. 平台超级商户可以返回所有的用户数据
3. 用户管理查询接口/users应该返回用户所属的商户,前端也应该正确展示商户信息
# 角色管理
1. 角色管理的所有操作都应该是基于所属的商户下面
3. 用户管理查询接口/roles应该返回用户所属的商户的角色信息
# 日志管理
1. 包括登录日志和操作日志
2. 这个模块只有平台商户才拥有的权限,/login-logs和operation-logs接口应该返回所属的商户的信息,前端也应该展示商户信息