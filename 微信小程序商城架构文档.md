# 微信小程序商城架构文档

## 1. 项目概述

### 1.1 项目背景
微信小程序商城是一个基于微信生态的电商平台，包含用户端小程序和后台管理系统，为商家提供完整的线上销售解决方案。

### 1.2 核心功能
- **用户端（小程序）**：商品浏览、购物车、订单管理、支付、用户中心
- **管理端（Web）**：商品管理、订单管理、用户管理、数据统计、系统配置

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────┐    ┌─────────────────┐
│   微信小程序     │    │   后台管理系统   │
│   (用户端)      │    │ (Vue3 + Vben)   │
│  Token认证      │    │ Session+Cookie  │
└─────────────────┘    └─────────────────┘
         │                       │
         │                       │
         └───────────┬───────────┘
                     │
              ┌─────────────┐
              │   API网关   │
              │ (认证路由)   │
              └─────────────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
  │  用户服务   │ │  商品服务   │ │  订单服务   │
  │             │ │             │ │             │
  └─────────────┘ └─────────────┘ └─────────────┘
         │           │           │
         └───────────┼───────────┘
                     │
    ┌────────────────┼────────────────┐
    │                │                │
┌─────────┐   ┌─────────────┐   ┌─────────────┐
│  MySQL  │   │    Redis    │   │   消息队列   │
│ 业务数据 │   │Session/权限 │   │ RabbitMQ   │
└─────────┘   └─────────────┘   └─────────────┘
```

### 2.2 后台认证架构图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  管理员登录  │───▶│  验证码校验  │───▶│  密码验证   │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  权限加载   │◀───│  创建会话   │◀───│  用户状态检查│
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │
       ▼                   ▼
┌─────────────┐    ┌─────────────┐
│ Redis缓存   │    │  Cookie设置  │
│ 权限数据    │    │ HttpOnly    │
└─────────────┘    └─────────────┘
```

### 2.2 技术架构

#### 2.2.1 前端技术栈
- **微信小程序**
  - 框架：Taro 3.x (React语法)
  - UI组件：Taro UI / NutUI
  - 状态管理：Redux Toolkit / Zustand
  - 网络请求：Taro.request
  - 编译工具：Webpack 5

- **后台管理系统**
  - 框架：Vue-Vben-Admin (Vue 3 + TypeScript)
  - UI组件库：Ant Design Vue
  - 构建工具：Vite
  - 路由：Vue Router 4
  - 状态管理：Pinia

#### 2.2.2 后端技术栈
- **开发语言**：Node.js + TypeScript
- **框架**：NestJS
- **数据库**：MySQL 8.0 + Redis 6.2
- **认证授权**：
  - 小程序：微信登录 + 自定义Token
  - 后台管理：Session + Cookie + RBAC权限控制
  - 密码加密：bcrypt
  - 验证码：svg-captcha
- **消息队列**：RabbitMQ / Apache Kafka
- **文件存储**：阿里云OSS / 腾讯云COS
- **部署**：Docker + Kubernetes

## 3. 系统模块设计

### 3.1 用户模块
- 用户注册/登录（手机号验证码登录）
- 用户信息管理
- 收货地址管理
- 用户等级体系

### 3.2 商品模块
- 商品分类管理（三级分类结构）
- 商品信息管理（SPU/SKU）
- 商品库存管理
- 商品搜索
- 商品推荐
- 折扣专区管理
- 热销专区管理

**分类结构说明：**
- **一级分类**：如数码电子、服装鞋帽、家居生活等
- **二级分类**：如手机通讯、电脑办公、男装、女装等  
- **三级分类**：如智能手机、游戏手机、商务男装、休闲男装等

**专区功能设计：**
- **折扣专区**：展示有折扣的商品，按折扣力度排序
- **热销专区**：展示热销商品，按销量排序
- **首页展示**：每个专区显示前3个商品
- **专区列表页**：点击"查看更多"跳转到完整列表
- **动态更新**：支持实时更新专区商品

### 3.3 Banner轮播模块
- Banner图片管理
- 商品列表关联配置
- 跳转类型配置
- 展示顺序控制
- 点击统计分析

**Banner类型设计：**
- **商品列表型**：点击跳转到指定商品列表页面
- **单品推广型**：点击跳转到商品详情页
- **分类导航型**：点击跳转到分类页面
- **活动推广型**：点击跳转到活动页面
- **外链型**：点击跳转到外部链接

**关联商品配置：**
- **手动选择**：管理员手动选择关联商品
- **分类筛选**：按分类自动筛选商品
- **标签筛选**：按商品标签筛选
- **智能推荐**：基于销量、评分等智能推荐

### 3.4 订单模块
- 购物车管理
- 订单创建
- 订单支付
- 订单状态管理
- 订单退款/售后

### 3.5 营销模块
- 优惠券系统
- 拼团活动
- 秒杀活动
- 积分系统

### 3.6 支付模块
- 微信支付集成
- 支付回调处理
- 退款处理

### 3.7 后台管理模块

#### 3.7.1 认证管理
- 管理员登录/登出
- Session会话管理
- 图形验证码验证
- 密码安全策略
- 登录日志记录

#### 3.7.2 权限管理
- RBAC权限控制模型
- 角色管理（超级管理员、商品管理员、订单管理员等）
- 权限管理（菜单权限、路由权限、按钮权限）
- 管理员账户管理
- 权限动态分配

**权限类型说明：**
- **菜单权限**：控制左侧菜单的显示和隐藏
- **路由权限**：控制页面路由的访问权限
- **按钮权限**：控制页面内操作按钮的显示和功能

#### 3.7.3 商品管理
- 商品基本信息管理
- 商品分类管理
- 商品库存管理
- 商品状态控制
- **专区配置管理**

**专区配置功能：**
- **热销商品配置**：设置商品是否为热销商品
- **折扣商品配置**：设置商品是否为折扣商品，配置折扣率
- **专区排序管理**：调整商品在专区中的显示顺序
- **批量操作**：支持批量设置商品专区状态
- **专区预览**：实时预览专区展示效果

#### 3.7.4 系统管理
- 系统配置管理
- 日志管理系统
- 数据统计分析
- 系统监控告警
- 缓存管理

**日志管理功能：**
- **登录日志**：记录管理员登录/登出行为，包括登录时间、IP地址、设备信息、登录结果
- **操作日志**：记录管理员的所有操作行为，包括增删改查、状态变更、批量操作等
- **系统日志**：记录系统异常、错误信息、性能问题等
- **日志查询**：支持多维度日志查询和统计分析
- **日志导出**：支持日志数据导出和备份

## 4. 数据库设计

### 4.1 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(64) UNIQUE NOT NULL,
  unionid VARCHAR(64),
  nickname VARCHAR(50),
  avatar_url VARCHAR(255),
  phone VARCHAR(20),
  gender TINYINT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 商品表 (products)
```sql
CREATE TABLE products (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category_id BIGINT,
  price DECIMAL(10,2) NOT NULL,
  original_price DECIMAL(10,2) COMMENT '原价',
  discount_rate DECIMAL(5,2) DEFAULT 0 COMMENT '折扣率(0-100)',
  stock INT DEFAULT 0,
  sales_count INT DEFAULT 0 COMMENT '销量',
  view_count INT DEFAULT 0 COMMENT '浏览量',
  images JSON,
  is_discount TINYINT DEFAULT 0 COMMENT '是否折扣商品：1-是，0-否',
  is_hot TINYINT DEFAULT 0 COMMENT '是否热销商品：1-是，0-否',
  sort_order INT DEFAULT 0 COMMENT '排序权重',
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 订单表 (orders)
```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id BIGINT NOT NULL,
  total_amount DECIMAL(10,2) NOT NULL,
  status TINYINT DEFAULT 1,
  payment_status TINYINT DEFAULT 0,
  shipping_address JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 4.2 后台管理权限表设计

#### 管理员表 (admins)
```sql
CREATE TABLE admins (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  real_name VARCHAR(50),
  email VARCHAR(100),
  phone VARCHAR(20),
  avatar VARCHAR(255),
  status TINYINT DEFAULT 1 COMMENT '1:正常 0:禁用',
  last_login_time TIMESTAMP,
  last_login_ip VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 角色表 (roles)
```sql
CREATE TABLE roles (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  code VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 权限表 (permissions)
```sql
CREATE TABLE permissions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  code VARCHAR(100) UNIQUE NOT NULL,
  type TINYINT NOT NULL COMMENT '1:菜单权限 2:路由权限 3:按钮权限',
  parent_id BIGINT DEFAULT 0,
  path VARCHAR(200),
  component VARCHAR(200),
  icon VARCHAR(50),
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 管理员角色关联表 (admin_roles)
```sql
CREATE TABLE admin_roles (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  admin_id BIGINT NOT NULL,
  role_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_admin_role (admin_id, role_id)
);
```

#### 角色权限关联表 (role_permissions)
```sql
CREATE TABLE role_permissions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  role_id BIGINT NOT NULL,
  permission_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_role_permission (role_id, permission_id)
);
```

#### 管理员登录日志表 (admin_login_logs)
```sql
CREATE TABLE admin_login_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  admin_id BIGINT,
  username VARCHAR(50) NOT NULL,
  ip VARCHAR(50),
  user_agent TEXT,
  login_location VARCHAR(100),
  status TINYINT NOT NULL COMMENT '1:成功 0:失败',
  message VARCHAR(255),
  login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  logout_time TIMESTAMP NULL
);
```

#### 管理员操作日志表 (admin_operation_logs)
```sql
CREATE TABLE admin_operation_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  admin_id BIGINT NOT NULL,
  username VARCHAR(50) NOT NULL,
  module VARCHAR(50) NOT NULL,
  operation VARCHAR(50) NOT NULL,
  method VARCHAR(10) NOT NULL,
  url VARCHAR(500) NOT NULL,
  ip VARCHAR(50),
  user_agent TEXT,
  request_params TEXT,
  response_result TEXT,
  status TINYINT DEFAULT 1 COMMENT '1:成功 0:失败',
  error_message TEXT,
  execution_time INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Banner轮播图表 (banners)
```sql
CREATE TABLE banners (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(100) NOT NULL,
  image_url VARCHAR(500) NOT NULL,
  link_type TINYINT NOT NULL COMMENT '1:商品列表 2:商品详情 3:分类页面 4:活动页面 5:外链',
  link_value VARCHAR(500),
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1 COMMENT '1:启用 0:禁用',
  start_time TIMESTAMP NULL,
  end_time TIMESTAMP NULL,
  click_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### Banner关联商品表 (banner_products)
```sql
CREATE TABLE banner_products (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  banner_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_banner_product (banner_id, product_id)
);
```

### 4.3 Redis缓存设计
- 用户会话：`session:{user_id}`
- 管理员会话：`admin_session:{session_id}`
- 管理员权限缓存：`admin_permissions:{admin_id}`
- 商品缓存：`product:{product_id}`
- 购物车：`cart:{user_id}`
- 热门商品：`hot_products`
- 图形验证码：`captcha:{captcha_id}`
- Banner列表：`banners:active` (有效的Banner列表)
- Banner关联商品：`banner_products:{banner_id}` (Banner关联的商品列表)
- Banner点击统计：`banner_clicks:{banner_id}:{date}` (每日点击统计)
- 折扣专区商品：`discount_zone_products` (折扣专区商品列表)
- 热销专区商品：`hot_zone_products` (热销专区商品列表)
- 首页专区数据：`homepage_zones` (首页专区展示数据)

## 5. API设计

### 5.1 RESTful API规范
- 基础URL：`https://api.example.com/v1`
- 小程序API认证：自定义Token验证
- 后台管理API认证：Session + Cookie
- 响应格式：JSON
- 状态码：遵循HTTP标准状态码

### 5.2 核心API接口

#### 用户相关
```
POST /auth/login          # 用户登录
GET  /user/profile        # 获取用户信息
PUT  /user/profile        # 更新用户信息
GET  /user/addresses      # 获取收货地址
POST /user/addresses      # 添加收货地址
```

#### 商品相关
```
GET  /products            # 获取商品列表
GET  /products/{id}       # 获取商品详情
GET  /categories          # 获取商品分类（树形结构，支持三级分类）
GET  /categories/tree     # 获取分类树形结构
GET  /categories/{id}/children  # 获取指定分类的子分类
GET  /products/search     # 商品搜索
GET  /products/category/{id}    # 根据分类获取商品
```

#### Banner相关
```
GET    /banners               # 获取Banner列表
GET    /banners/{id}/products # 获取Banner关联商品列表
POST   /banners/{id}/click    # 记录Banner点击
```

#### 专区相关
```
GET    /zones/homepage        # 获取首页专区数据（折扣专区前3+热销专区前3）
GET    /zones/discount        # 获取折扣专区商品列表
GET    /zones/hot             # 获取热销专区商品列表
GET    /zones/discount/products  # 获取折扣专区商品详细列表（分页）
GET    /zones/hot/products    # 获取热销专区商品详细列表（分页）
```

#### 订单相关
```
GET  /cart                # 获取购物车
POST /cart/add            # 添加到购物车
POST /orders              # 创建订单
GET  /orders              # 获取订单列表
GET  /orders/{id}         # 获取订单详情
```

### 5.3 后台管理API接口

#### 认证相关
```
POST /admin/auth/login       # 管理员登录
POST /admin/auth/logout      # 管理员登出
GET  /admin/auth/captcha     # 获取图形验证码
GET  /admin/auth/profile     # 获取当前管理员信息
PUT  /admin/auth/profile     # 更新管理员信息
PUT  /admin/auth/password    # 修改密码
```

#### 管理员管理
```
GET    /admin/admins         # 获取管理员列表
POST   /admin/admins         # 创建管理员
GET    /admin/admins/{id}    # 获取管理员详情
PUT    /admin/admins/{id}    # 更新管理员信息
DELETE /admin/admins/{id}    # 删除管理员
PUT    /admin/admins/{id}/status  # 更新管理员状态
```

#### 角色管理
```
GET    /admin/roles          # 获取角色列表
POST   /admin/roles          # 创建角色
GET    /admin/roles/{id}     # 获取角色详情
PUT    /admin/roles/{id}     # 更新角色信息
DELETE /admin/roles/{id}     # 删除角色
GET    /admin/roles/{id}/permissions  # 获取角色权限
PUT    /admin/roles/{id}/permissions  # 设置角色权限
```

#### 权限管理
```
GET    /admin/permissions    # 获取权限列表（树形结构）
POST   /admin/permissions    # 创建权限
GET    /admin/permissions/{id}  # 获取权限详情
PUT    /admin/permissions/{id}  # 更新权限信息
DELETE /admin/permissions/{id}  # 删除权限
```

#### 商品管理
```
GET    /admin/products       # 获取商品列表
POST   /admin/products       # 创建商品
GET    /admin/products/{id}  # 获取商品详情
PUT    /admin/products/{id}  # 更新商品信息
DELETE /admin/products/{id}  # 删除商品
PUT    /admin/products/{id}/status  # 更新商品状态
PUT    /admin/products/{id}/hot     # 设置热销状态
PUT    /admin/products/{id}/discount # 设置折扣状态和折扣率
PUT    /admin/products/{id}/zone-sort # 设置专区排序权重
POST   /admin/products/batch/hot    # 批量设置热销状态
POST   /admin/products/batch/discount # 批量设置折扣状态

GET    /admin/categories     # 获取分类列表（支持三级分类树形结构）
POST   /admin/categories     # 创建分类
GET    /admin/categories/{id}  # 获取分类详情
PUT    /admin/categories/{id}  # 更新分类信息
DELETE /admin/categories/{id}  # 删除分类
PUT    /admin/categories/{id}/status  # 更新分类状态
GET    /admin/categories/tree  # 获取完整分类树

GET    /admin/brands         # 获取品牌列表
POST   /admin/brands         # 创建品牌
PUT    /admin/brands/{id}    # 更新品牌信息
DELETE /admin/brands/{id}    # 删除品牌
```

#### 订单管理
```
GET    /admin/orders         # 获取订单列表
GET    /admin/orders/{id}    # 获取订单详情
PUT    /admin/orders/{id}/status  # 更新订单状态
POST   /admin/orders/{id}/ship    # 发货
POST   /admin/orders/{id}/refund  # 退款
```

#### Banner管理
```
GET    /admin/banners        # 获取Banner列表
POST   /admin/banners        # 创建Banner
GET    /admin/banners/{id}   # 获取Banner详情
PUT    /admin/banners/{id}   # 更新Banner
DELETE /admin/banners/{id}   # 删除Banner
PUT    /admin/banners/{id}/status  # 更新Banner状态
GET    /admin/banners/{id}/products  # 获取Banner关联商品
POST   /admin/banners/{id}/products  # 添加Banner关联商品
DELETE /admin/banners/{id}/products/{productId}  # 移除Banner关联商品
GET    /admin/banners/statistics  # 获取Banner统计数据
```

#### 专区管理
```
GET    /admin/zones/discount/products    # 获取折扣专区商品列表
POST   /admin/zones/discount/products    # 添加商品到折扣专区
DELETE /admin/zones/discount/products/{id}  # 从折扣专区移除商品
PUT    /admin/zones/discount/products/{id}  # 更新折扣专区商品信息
GET    /admin/zones/hot/products         # 获取热销专区商品列表
POST   /admin/zones/hot/products         # 添加商品到热销专区
DELETE /admin/zones/hot/products/{id}    # 从热销专区移除商品
PUT    /admin/zones/hot/products/{id}    # 更新热销专区商品信息
POST   /admin/zones/refresh              # 刷新专区数据缓存
GET    /admin/zones/statistics           # 获取专区统计数据
```

#### 日志管理
```
GET    /admin/logs/login     # 获取登录日志列表
GET    /admin/logs/login/{id}  # 获取登录日志详情
GET    /admin/logs/operation # 获取操作日志列表
GET    /admin/logs/operation/{id}  # 获取操作日志详情
GET    /admin/logs/statistics  # 获取日志统计信息
POST   /admin/logs/export    # 导出日志数据
DELETE /admin/logs/clean     # 清理过期日志
GET    /admin/logs/online    # 获取在线管理员列表
```

## 6. 安全设计

### 6.1 认证授权

#### 6.1.1 微信小程序认证
- 使用微信登录授权获取用户信息
- 通过微信code换取session_key
- 服务端生成自定义token用于后续请求

#### 6.1.2 后台管理系统认证
采用传统的Session + Cookie认证方式：

**登录流程：**
1. 管理员输入用户名/密码 + 图形验证码
2. 服务端验证用户信息和验证码
3. 验证成功后创建Session存储到Redis
4. 返回SessionID通过Cookie设置到浏览器
5. 后续请求携带Cookie进行身份验证

**技术实现：**
- Session存储：Redis（支持集群部署）
- Cookie配置：HttpOnly + Secure + SameSite
- 会话超时：30分钟无操作自动过期
- 记住我功能：7天免登录（可选）

**权限控制（RBAC）：**
- 角色管理：超级管理员、运营管理员、客服等
- 权限管理：菜单权限、路由权限、按钮权限
- 权限验证：基于注解的权限拦截器

**权限类型详解：**
- 菜单权限：控制侧边栏菜单项的显示/隐藏
- 路由权限：控制页面路由的访问，防止直接URL访问
- 按钮权限：控制页面内增删改查等操作按钮

#### 6.1.3 API接口安全
- 小程序API：自定义Token验证
- 管理后台API：Session验证 + CSRF Token
- 第三方API：签名验证机制

### 6.2 数据安全
- 敏感数据加密存储
- HTTPS传输加密
- SQL注入防护
- XSS攻击防护

### 6.3 业务安全
- 接口限流
- 防刷机制
- 订单防重复提交
- 支付安全验证

## 7. 性能优化

### 7.1 前端优化
- 小程序分包加载
- 图片懒加载
- 数据缓存策略
- 代码压缩混淆

### 7.2 后端优化
- 数据库索引优化
- Redis缓存策略
- CDN加速
- 数据库读写分离

### 7.3 系统监控
- 应用性能监控（APM）
- 日志收集分析
- 错误报警机制
- 业务指标监控

## 8. 环境配置与部署

### 8.1 环境区分设计

#### 8.1.1 环境分类
项目采用三环境部署模式，确保开发、测试、生产环境的隔离和稳定性：

**开发环境 (Development)**
- **用途**：本地开发调试
- **特点**：配置简单，日志详细，支持热重载
- **数据库**：本地MySQL，测试数据
- **缓存**：本地Redis，无密码
- **存储**：本地文件存储
- **监控**：基础日志，详细错误信息
- **端口配置**：API:3000, Admin:8080, DB:3306, Redis:6379

**测试环境 (Testing)**
- **用途**：功能测试，集成测试，性能测试
- **特点**：接近生产环境配置，模拟真实场景
- **数据库**：独立测试数据库，定期重置
- **缓存**：Redis集群，密码保护
- **存储**：云存储（测试bucket）
- **监控**：完整监控体系，性能分析
- **端口配置**：API:3001, Admin:8081, DB:3307, Redis:6380

**生产环境 (Production)**
- **用途**：正式对外服务
- **特点**：高可用，高性能，高安全性
- **数据库**：主从复制，读写分离
- **缓存**：Redis集群，持久化
- **存储**：CDN加速，多地备份
- **监控**：全链路监控，告警机制
- **端口配置**：HTTP:80, HTTPS:443

#### 8.1.2 环境配置管理

**配置文件结构**
```
project/
├── config/
│   └── environments/
│       ├── development.env    # 开发环境配置
│       ├── testing.env        # 测试环境配置
│       └── production.env     # 生产环境配置
├── database/
│   └── environments/
│       ├── development.sql    # 开发环境数据库初始化
│       ├── testing.sql        # 测试环境数据库初始化
│       └── production.sql     # 生产环境数据库初始化
└── docker/
    ├── docker-compose.dev.yml    # 开发环境容器编排
    ├── docker-compose.test.yml   # 测试环境容器编排
    └── docker-compose.prod.yml   # 生产环境容器编排
```

**环境变量设计**
- **基础配置**：NODE_ENV, PORT, API_PREFIX
- **数据库配置**：DB_HOST, DB_PORT, DB_USERNAME, DB_PASSWORD, DB_DATABASE
- **Redis配置**：REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, REDIS_DB
- **微信配置**：WECHAT_APPID, WECHAT_SECRET
- **支付配置**：WECHAT_PAY_MCHID, WECHAT_PAY_KEY, WECHAT_PAY_CERT_PATH
- **存储配置**：STORAGE_TYPE, OSS_BUCKET, CDN_DOMAIN
- **安全配置**：JWT_SECRET, SESSION_SECRET, CORS_ORIGIN
- **监控配置**：LOG_LEVEL, SENTRY_DSN, SENTRY_ENVIRONMENT

#### 8.1.3 数据库环境隔离

**开发环境数据库**
- 数据库名：`wechat_mall_dev`
- 字符集：utf8mb4_unicode_ci
- 用户权限：完整权限，便于调试
- 数据初始化：包含完整测试数据
- 日志级别：详细查询日志
- 性能配置：开发友好，不限制资源

**测试环境数据库**
- 数据库名：`wechat_mall_test`
- 字符集：utf8mb4_unicode_ci
- 用户权限：受限权限，模拟生产
- 数据初始化：标准测试数据集
- 性能监控：慢查询分析
- 自动重置：定期清理和重置数据

**生产环境数据库**
- 数据库名：`wechat_mall_prod`
- 主从配置：读写分离，负载均衡
- 用户权限：最小权限原则
- 数据备份：定时备份，异地存储
- 性能优化：索引优化，查询缓存
- 监控告警：实时监控，异常告警

#### 8.1.4 容器化部署策略

**开发环境容器配置**
- 部署方式：单机Docker Compose
- 数据存储：本地数据卷挂载
- 开发支持：热重载，调试端口暴露
- 服务发现：Docker内部网络
- 日志管理：控制台输出，本地文件

**测试环境容器配置**
- 部署方式：多容器集群部署
- 数据存储：持久化存储卷
- 健康检查：容器健康检查机制
- 自动化集成：CI/CD自动部署
- 监控体系：Prometheus + Grafana

**生产环境容器配置**
- 部署方式：Docker Swarm/Kubernetes编排
- 高可用性：多副本负载均衡
- 更新策略：滚动更新，零停机部署
- 资源限制：CPU和内存限制
- 监控告警：全链路监控，实时告警

#### 8.1.5 环境切换管理

**环境管理脚本**
```bash
# 设置开发环境
./scripts/env-manager.sh setup dev

# 启动测试环境
./scripts/env-manager.sh start test --build

# 查看生产环境状态
./scripts/env-manager.sh status prod
```

**配置加载机制**
- 环境检测：通过NODE_ENV自动识别环境
- 配置合并：基础配置 + 环境特定配置
- 敏感信息：生产环境使用环境变量注入
- 配置验证：启动时验证必要配置项

### 8.2 部署架构

#### 8.2.1 部署方案
```
                    ┌─────────────────┐
                    │   负载均衡器     │
                    │   (Nginx)       │
                    └─────────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ 小程序后端   │ │ 管理后台后端 │ │ 管理前端     │
    │ (NestJS)   │ │ (NestJS)    │ │ (Vue3)      │
    │ Token认证   │ │Session认证  │ │ 静态资源     │
    └─────────────┘ └─────────────┘ └─────────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                   │                    │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   MySQL     │    │    Redis    │    │   文件存储   │
│ (主从复制)   │    │ Session/权限 │    │   (OSS)     │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 8.3 安全部署配置

#### Nginx配置
```nginx
# 后台管理系统安全配置
server {
    listen 443 ssl http2;
    server_name admin.example.com;
    
    # SSL证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 安全头设置
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000";
    
    # 后台管理前端
    location / {
        root /var/www/admin;
        try_files $uri $uri/ /index.html;
    }
    
    # 后台API代理
    location /admin/api/ {
        proxy_pass http://backend_admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Session Cookie安全
        proxy_cookie_flags ~ httponly samesite=strict secure;
    }
}

# 小程序API服务
server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    location /api/ {
        proxy_pass http://backend_miniprogram;
        # ... 其他配置
    }
}
```

## 9. 开发流程

### 9.1 开发规范
- 代码规范：ESLint + Prettier
- Git工作流：GitFlow
- 代码审查：Pull Request
- 自动化测试：单元测试 + 集成测试

### 9.2 CI/CD流程
1. 代码提交到Git仓库
2. 触发自动化构建
3. 运行测试用例
4. 构建Docker镜像
5. 部署到对应环境
6. 自动化测试验证

## 10. 运维监控

### 10.1 监控指标
- 系统指标：CPU、内存、磁盘、网络
- 应用指标：QPS、响应时间、错误率
- 业务指标：订单量、支付成功率、用户活跃度

### 10.2 日志管理
- 日志收集：ELK Stack (Elasticsearch + Logstash + Kibana)
- 日志分级：ERROR、WARN、INFO、DEBUG
- 日志轮转：按时间和大小轮转

## 11. 扩展性设计

### 11.1 水平扩展
- 微服务架构
- 数据库分库分表
- 缓存集群
- 消息队列集群

### 11.2 功能扩展
- 直播带货
- 社交电商
- 会员体系
- 积分商城
- 拼团功能
- 秒杀活动

## 12. 项目计划

### 12.1 开发阶段
- 第一阶段（4周）：基础架构搭建、用户模块
- 第二阶段（6周）：商品模块、订单模块
- 第三阶段（4周）：支付模块、营销模块
- 第四阶段（2周）：测试优化、上线部署

### 12.2 团队配置
- 项目经理：1人
- 前端开发：2人（小程序1人 + 管理后台1人）
- 后端开发：2人
- UI设计师：1人
- 测试工程师：1人
- 运维工程师：1人

---

*本文档将根据项目进展持续更新和完善*