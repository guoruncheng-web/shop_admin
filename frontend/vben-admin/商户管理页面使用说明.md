# 商户管理页面使用说明

## 页面位置

- **文件路径**: `apps/web-ele/src/views/system/merchants/index.vue`
- **路由路径**: `/system/merchants` (需要在后端菜单中配置)

## 功能概述

商户管理页面提供了完整的商户管理功能，包括：

1. **商户列表查询**：支持多条件搜索和分页
2. **创建商户**：自动生成超级管理员账号
3. **编辑商户**：更新商户信息
4. **状态管理**：启用/禁用/冻结商户
5. **认证管理**：更新商户认证状态
6. **统计信息**：查看商户数据统计
7. **API密钥管理**：重新生成商户API密钥
8. **删除商户**：删除商户（谨慎操作）

## 核心功能详解

### 1. 创建商户

**步骤**：
1. 点击"➕ 新增商户"按钮
2. 填写商户信息（必填项：商户编码、商户名称）
3. 可选填写：联系信息、经营信息、配额设置等
4. 点击"创建"按钮

**自动操作**：
- 系统会自动生成商户API密钥对
- 自动创建超级管理员账号（随机用户名和密码）
- 自动创建超级管理员角色
- 自动分配菜单管理权限
- 所有数据关联到该商户（merchant_id）

**重要提示**：
- 创建成功后会弹出管理员凭证对话框
- **密码仅显示一次，请务必保存！**
- 可以复制用户名、密码和邮箱

### 2. 搜索和筛选

支持的搜索条件：
- 商户编码（模糊搜索）
- 商户名称（模糊搜索）
- 商户类型（超级商户/普通商户）
- 状态（启用/禁用/冻结）
- 认证状态（未认证/审核中/已认证/认证失败）

### 3. 商户信息展示

列表显示的信息：
- 商户ID
- 商户信息（名称+编码）
- 商户类型
- 联系信息（姓名+电话+邮箱）
- 配额信息（商品/管理员/存储空间）
- 状态
- 认证状态
- 创建时间

### 4. 操作功能

每个商户支持以下操作：

#### 主要操作
- **编辑**：修改商户基本信息
- **启用/禁用**：快速切换商户状态

#### 更多操作（下拉菜单）
- **认证管理**：更新商户认证状态（未认证→审核中→已认证/认证失败）
- **统计信息**：查看商户的账户余额、销售额、配额使用情况
- **重新生成密钥**：重新生成API Key和Secret（旧密钥立即失效）
- **删除商户**：永久删除商户（不可恢复）

## 组件结构

```
merchants/
├── index.vue                          # 主页面
└── components/
    ├── MerchantForm.vue              # 商户表单对话框
    └── AdminCredentialsDialog.vue    # 管理员凭证展示对话框
```

## API 接口

所有API接口定义在：`src/api/system/merchant.ts`

主要接口：
- `getMerchantListApi()` - 获取商户列表
- `createMerchantApi()` - 创建商户
- `updateMerchantApi()` - 更新商户
- `deleteMerchantApi()` - 删除商户
- `updateMerchantStatusApi()` - 更新状态
- `updateMerchantCertificationApi()` - 更新认证状态
- `getMerchantStatisticsApi()` - 获取统计信息
- `regenerateMerchantKeysApi()` - 重新生成密钥

## 数据字典

### 商户类型 (merchantType)
- `1` - 超级商户（平台）
- `2` - 普通商户

### 状态 (status)
- `0` - 禁用
- `1` - 启用
- `2` - 冻结

### 认证状态 (certificationStatus)
- `0` - 未认证
- `1` - 审核中
- `2` - 已认证
- `3` - 认证失败

## 配置菜单（后端）

要使页面在系统中显示，需要在后端添加菜单配置：

```sql
INSERT INTO menus (
  merchant_id,
  parent_id,
  menu_type,
  menu_name,
  menu_code,
  route_path,
  component_path,
  icon,
  sort_order,
  status,
  visible
) VALUES (
  1,                          -- 平台商户
  NULL,                       -- 如果是顶级菜单，或填写父菜单ID
  2,                          -- 菜单类型：2-菜单
  '商户管理',                 -- 菜单名称
  'system:merchant',          -- 菜单代码
  '/system/merchants',        -- 路由路径
  'system/merchants/index',   -- 组件路径
  'Shop',                     -- 图标
  10,                         -- 排序
  1,                          -- 状态：启用
  1                           -- 是否可见
);
```

## 使用流程示例

### 场景1：创建新商户

1. 管理员登录系统
2. 进入"商户管理"页面
3. 点击"➕ 新增商户"
4. 填写表单：
   ```
   商户编码: SHOP_2025_001
   商户名称: 示例电商平台
   联系人姓名: 张三
   联系电话: 13800138000
   联系邮箱: contact@shop.com
   商户描述: 这是一个示例电商平台
   最大商品数量: 1000
   最大管理员数量: 20
   最大存储空间: 10 GB
   ```
5. 点击"创建"
6. 系统创建成功后显示管理员凭证对话框
7. **重要**：复制并保存管理员账号信息：
   ```
   用户名: admin_kxakmak6
   密码: twuKNw@a4&*Q
   邮箱: admin_kxakmak6@shop_2025_001.com
   ```
8. 点击"我已保存"关闭对话框

### 场景2：管理商户状态

1. 在商户列表找到目标商户
2. 点击"禁用"或"启用"按钮
3. 确认操作
4. 状态更新成功

### 场景3：查看商户统计

1. 点击商户行的"更多"按钮
2. 选择"统计信息"
3. 查看详细数据：
   - 账户余额
   - 冻结金额
   - 累计销售额
   - 当前商品数 / 最大商品数
   - 当前管理员数 / 最大管理员数
   - 已用存储空间 / 最大存储空间

## 注意事项

### 安全性
1. **密码保护**：创建商户时返回的密码仅显示一次，数据库存储的是加密后的密码
2. **权限控制**：所有操作需要相应的权限
3. **操作日志**：建议记录所有重要操作的日志

### 数据一致性
1. **超级商户保护**：超级商户（merchantType=1）不能删除或禁用
2. **商户编码唯一性**：商户编码必须唯一，创建和更新时会自动校验
3. **关联数据**：删除商户前请确认没有关联的重要数据

### 最佳实践
1. **命名规范**：商户编码建议使用统一的命名规范，如：`SHOP_YYYY_XXX`
2. **配额设置**：根据商户规模合理设置配额
3. **定期审计**：定期检查商户状态和认证状态
4. **备份密钥**：妥善保管API密钥和管理员密码

## 故障排查

### 问题1：页面无法访问
- 检查路由配置是否正确
- 检查菜单权限是否分配
- 检查后端API是否正常

### 问题2：创建商户失败
- 检查商户编码是否重复
- 检查必填字段是否填写
- 查看浏览器控制台错误信息

### 问题3：管理员凭证对话框不显示
- 检查后端是否正确返回 `superAdmin` 字段
- 检查网络请求是否成功
- 刷新页面重新创建

## 相关文档

- 后端API文档：`/database/商户管理接口文档.md`
- 功能说明文档：`/database/商户自动管理员功能说明.md`
- 后端测试脚本：`/test-complete-merchant-flow.sh`

## 更新日志

- **2025-10-10**: 初始版本
  - 完成商户CRUD功能
  - 实现自动创建管理员功能
  - 添加状态和认证管理
  - 添加统计信息查看
  - 添加API密钥管理
